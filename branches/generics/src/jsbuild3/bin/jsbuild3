#! /usr/bin/env node
// -*- js -*-

"use strict";

var config = require("../lib/config")
var ARGS = require("optimist")
    .usage("$0 config")
    .describe("config", "Specify an path to config file")
    .default("config", "jsbuild.json")
    .string("config")
    .describe("modules", "Specify modules to build")
    .string("modules")
    //.optional("modules")
    .wrap(80)
    .argv;

var fs = require("fs");
var Path = require("path");
var CFG = new config.Configuration(JSON.parse(fs.readFileSync(ARGS.config)), ARGS.config);
// todo: load plugins
for(var plugin in CFG.getPlugins()) {
    console.info(plugin.path);
}

var JsBuild3 = require("../tools/jsbuild");

var MODULES = (ARGS.modules || '');
var toBuild = CFG.getModules();
if (MODULES.length) {
    MODULES = MODULES.split(',').filter(function(_) { return _ != null; });
    toBuild = toBuild.filter(function (module) {
        return MODULES.indexOf(module.getName()) >= 0;
    });
}

toBuild.forEach(/** @param {ModuleConfiguration} module */ function (module) {
    CFG.setModuleConfig(module);

    console.info('Processing: ' + module.getName());

    var fileContents = JsBuild3.compile(module.getInFile() || module.getAppClass(), CFG, module.getAppClass());
    var outPath = Path.resolve(CFG.getBasePath() + module.getOutFile());

    var jsbuildParams = CFG.getPluginConfiguration("jsbuild");
    fs.writeFileSync(outPath, fileContents.join(jsbuildParams.separator || ';'), "utf-8");
});

console.info("done");

